<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Gestion Boutique</h2>
    <button class="btn btn-primary shadow-sm" (click)="toggleForm()">
      <span *ngIf="!showForm">‚ûï Ajouter un article</span>
      <span *ngIf="showForm">‚ùå Fermer</span>
    </button>
  </div>

  <!-- Formulaire d'ajout -->
  <div class="card mb-4 shadow-sm" *ngIf="showForm">
    <div class="card-header">
      <h3 class="h5 mb-0">{{ editingItemId ? 'Modifier l\'article' : 'Nouvel Article Boutique' }}</h3>
    </div>
    <div class="card-body">
      <form [formGroup]="boutiqueForm" (ngSubmit)="onSubmit()">
        
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Titre du produit *</label>
            <input type="text" formControlName="title" class="form-control" placeholder="Ex: N¬∞5">
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Marque</label>
            <input type="text" formControlName="brand" class="form-control" placeholder="Ex: Chanel">
          </div>
        </div>

        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">Cat√©gorie</label>
            <select formControlName="category" class="form-select shadow-sm" style="cursor: pointer;">
              <option value="Eau de Parfum">Eau de Parfum</option>
              <option value="Eau de Toilette">Eau de Toilette</option>
              <option value="Extrait">Extrait</option>
              <option value="Cologne">Cologne</option>
            </select>
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Genre</label>
            <select formControlName="gender" class="form-select shadow-sm" style="cursor: pointer;">
              <option value="Femme">Femme</option>
              <option value="Homme">Homme</option>
              <option value="Unisexe">Unisexe</option>
            </select>
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Contenance (ml)</label>
            <input type="number" formControlName="volume_ml" class="form-control">
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Famille Olfactive</label>
            <input type="text" formControlName="olfactory_family" class="form-control" placeholder="Ex: Floral Ald√©hyd√©">
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Prix Boutique (‚Ç¨) *</label>
            <input type="number" formControlName="price" class="form-control">
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Description Marketing</label>
          <textarea formControlName="description" class="form-control" rows="3"></textarea>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Image du produit</label>
            <input type="file" (change)="onFileSelected($event)" class="form-control" accept="image/png, image/jpeg">
            <div *ngIf="uploading" class="mt-2">
              <div class="progress" style="height: 20px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" 
                     [style.width.%]="uploadProgress" 
                     [attr.aria-valuenow]="uploadProgress" 
                     aria-valuemin="0" aria-valuemax="100">
                  {{ uploadProgress }}%
                </div>
              </div>
            </div>
            <div *ngIf="uploadedImageUrl" class="mt-2 d-flex align-items-center gap-2">
              <img [src]="uploadedImageUrl" (error)="onImageError($event)" alt="Aper√ßu" class="img-thumbnail" style="height: 100px;">
              <button type="button" (click)="removeImage()" class="btn btn-danger btn-sm">
                Supprimer
              </button>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Lien Vid√©o (YouTube/MP4)</label>
            <input type="text" formControlName="video_url" class="form-control" placeholder="https://...">
          </div>
        </div>

        <div class="row align-items-end">
          <div class="col-md-6 mb-3">
            <label class="form-label">Lier au Stock (Optionnel)</label>
            <select formControlName="product_id" class="form-select shadow-sm" style="cursor: pointer;">
              <option [ngValue]="null">-- Aucun lien --</option>
              <option *ngFor="let p of products$ | async" [value]="p.id">
                {{ p.name }} (Stock: {{ p.current_stock }})
              </option>
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <div class="d-flex gap-3">
              <div class="form-check">
                <input type="checkbox" formControlName="is_active" class="form-check-input" id="checkActive">
                <label class="form-check-label" for="checkActive">Actif</label>
              </div>
              <div class="form-check">
                <input type="checkbox" formControlName="is_featured" class="form-check-input" id="checkFeatured">
                <label class="form-check-label" for="checkFeatured">Mis en avant</label>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button type="submit" [disabled]="boutiqueForm.invalid || uploading" class="btn btn-success text-white shadow-sm">
            <span *ngIf="uploading" class="spinner-border spinner-border-sm me-2"></span>
            {{ editingItemId ? 'üíæ Mettre √† jour' : '‚úÖ Enregistrer l\'article' }}
          </button>
          <button type="button" (click)="cancelEdit()" class="btn btn-secondary shadow-sm">üö´ Annuler</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Barre de recherche et filtres -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <input type="text" [(ngModel)]="searchTerm" (input)="applyFilters()" placeholder="Rechercher un produit..." class="form-control">
        </div>
        <div class="col-md-3">
          <select [(ngModel)]="filterBrand" (change)="applyFilters()" class="form-select shadow-sm" style="cursor: pointer;">
            <option value="">Toutes les marques</option>
            <option *ngFor="let brand of uniqueBrands" [value]="brand">{{ brand }}</option>
          </select>
        </div>
        <div class="col-md-3">
          <select [(ngModel)]="filterCategory" (change)="applyFilters()" class="form-select shadow-sm" style="cursor: pointer;">
            <option value="">Toutes les cat√©gories</option>
            <option *ngFor="let cat of uniqueCategories" [value]="cat">{{ cat }}</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Liste rapide pour v√©rification -->
  <div class="card shadow-sm">
    <div class="card-header">
      <h3 class="h5 mb-0">Articles en Boutique ({{ filteredItems.length }})</h3>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>Image</th>
              <th>Titre</th>
              <th>Marque</th>
              <th>Prix</th>
              <th>Stock Li√©</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of paginatedItems">
              <td><img [src]="item.image_url || 'assets/placeholder-perfume.jpg'" (error)="onImageError($event)" class="rounded" style="width: 40px; height: 40px; object-fit: cover;"></td>
              <td>{{ item.title }}</td>
              <td>{{ item.brand }}</td>
              <td>{{ item.price | currency:'EUR' }}</td>
              <td>
                <span *ngIf="item.products" [class.text-danger]="item.products.current_stock === 0">{{ item.products.current_stock }} en stock</span>
                <span *ngIf="!item.products" class="text-muted">-</span>
              </td>
              <td>
                <span class="badge" [class.bg-success]="item.is_active" [class.bg-danger]="!item.is_active">{{ item.is_active ? 'Actif' : 'Inactif' }}</span>
                <span *ngIf="item.is_featured" class="ms-1">‚≠ê</span>
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-primary" (click)="editItem(item)">‚úèÔ∏è Modifier</button>
                  <button class="btn btn-outline-danger" (click)="deleteItem(item)">üóëÔ∏è Supprimer</button>
                </div>
              </td>
            </tr>
            <tr *ngIf="filteredItems.length === 0">
              <td colspan="7" class="text-center py-4 text-muted">Aucun article ne correspond √† votre recherche.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="card-footer bg-white d-flex justify-content-end" *ngIf="totalPages > 1">
      <nav aria-label="Page navigation">
        <ul class="pagination mb-0">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <a class="page-link" href="javascript:void(0)" (click)="changePage(currentPage - 1)">&laquo;</a>
          </li>
          <li class="page-item" *ngFor="let page of pages" [class.active]="page === currentPage">
            <a class="page-link" href="javascript:void(0)" (click)="changePage(page)">{{ page }}</a>
          </li>
          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <a class="page-link" href="javascript:void(0)" (click)="changePage(currentPage + 1)">&raquo;</a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</div>
